syntax = "proto3";
import "google/protobuf/empty.proto";
package persistence;

enum QueueTypePersistenceGrpcEnum {
   Permanent = 0;
   AutoDelete = 1;
   PermanentWithSingleConnection = 2;
}

message QueueIndexRangeGrpcModel {
  int64 FromId = 1;
  int64 ToId = 2;
}

message QueueSnapshotGrpcModel {
  string QueueId = 1;
  repeated persistence.QueueIndexRangeGrpcModel Ranges = 2;
  persistence.QueueTypePersistenceGrpcEnum QueueType = 3;
}

message SaveQueueSnapshotGrpcRequest {
  repeated persistence.TopicAndQueuesSnapshotGrpcModel QueueSnapshot = 1;
}

message TopicAndQueuesSnapshotGrpcModel {
  string TopicId = 1;
  int64 MessageId = 2;
  repeated persistence.QueueSnapshotGrpcModel QueueSnapshots = 3;
  optional bool Persist = 4;
}

service MyServiceBusQueuePersistenceGrpcService {

   rpc GetSnapshot(google.protobuf.Empty) returns (stream persistence.TopicAndQueuesSnapshotGrpcModel);
   rpc SaveSnapshot(persistence.SaveQueueSnapshotGrpcRequest) returns (google.protobuf.Empty);
}


///////////

message GetHistoryByDateGrpcRequest {
  string TopicId = 1;
  int64 FromDateTime = 2;
}

message MessageContentGrpcModel {
  int64 MessageId = 1;
  int64 Created = 2;
  bytes Data = 3;
  repeated persistence.MessageContentMetaDataItem MetaData = 4;
}

message MessageContentMetaDataItem {
  string Key = 1;
  string Value = 2;
}

service MyServiceBusHistoryReaderGrpcService {
   rpc GetByDate(persistence.GetHistoryByDateGrpcRequest) returns (stream persistence.MessageContentGrpcModel);
}


//////////////


message CompressedMessageChunkModel {
  bytes Chunk = 1;
}

message UnCompressedMessageChunkModel {
  bytes Chunk = 1;
}

message GetMessageGrpcRequest {
  string TopicId = 1;
  int64 MessageId = 2;
}

message GetPageCompressedGrpcRequest {
  string TopicId = 1;
  int64 PageNo = 2;
  int64 FromMessageId = 3;
  int64 ToMessageId = 4;
  int32 Version = 5;
}

message GetPageGrpcRequest {
  string TopicId = 1;
  int64 PageNo = 2;
  int64 FromMessageId = 3;
  int64 ToMessageId = 4;
  int32 Version = 5;
}

message GetVersionGrpcResponse{
  string Version = 1;
}

message DeleteTopicGrpcRequest {
  string TopicId = 1;
  int64 DeleteAfter = 2;
}

message GetSubPageGrpcRequest{
  string TopicId = 1;
  int64 SubPageNo = 2;
}


message RestoreTopicGrpcRequest{
  string TopicId = 1;
}

message RestoreTopicGrpcResponse{
  bool Result = 1;
  int64 MessageId = 2;
}

service MyServiceBusMessagesPersistenceGrpcService {
   rpc GetVersion(google.protobuf.Empty) returns (GetVersionGrpcResponse);
   rpc GetMessage(GetMessageGrpcRequest) returns (MessageContentGrpcModel);
   rpc GetPageCompressed(GetPageCompressedGrpcRequest) returns (stream CompressedMessageChunkModel);
   rpc GetPage(GetPageGrpcRequest) returns (stream MessageContentGrpcModel);
   rpc GetSubPage(GetSubPageGrpcRequest) returns (stream MessageContentGrpcModel);
   rpc SaveMessages(stream CompressedMessageChunkModel) returns (google.protobuf.Empty);
   rpc SaveMessagesUncompressed(stream UnCompressedMessageChunkModel) returns (google.protobuf.Empty);
   rpc DeleteTopic(DeleteTopicGrpcRequest) returns (google.protobuf.Empty);
   rpc RestoreTopic(RestoreTopicGrpcRequest) returns (RestoreTopicGrpcResponse);
   rpc Ping(google.protobuf.Empty) returns (google.protobuf.Empty);
}

